name: auto-merge-test-branch

on:
  push:
    branches:
      - test/trigger-ci-workflow

permissions:
  contents: write
  pull-requests: write

jobs:
  open-or-update-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create or update PR (auto-merge disabled)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          BASE="main"
          HEAD="test/trigger-ci-workflow"

          PR_NUMBER=$(gh pr list --base "$BASE" --head "$HEAD" --state open --json number -q '.[0].number')

          if [ -z "$PR_NUMBER" ]; then
            PR_URL=$(gh pr create \
              --base "$BASE" \
              --head "$HEAD" \
              --title "Auto-merge: sync test/trigger-ci-workflow" \
              --body "Automated PR from test/trigger-ci-workflow. Merges only after required checks pass.")
            PR_NUMBER=$(echo "$PR_URL" | awk -F/ '{print $NF}')
          fi

          # Wait until GitHub calculates mergeability to avoid unstable status
          echo "Waiting for PR #$PR_NUMBER to become mergeable..."
          for i in {1..30}; do
            MERGEABLE=$(gh pr view "$PR_NUMBER" --json mergeable,isDraft -q '.mergeable')
            IS_DRAFT=$(gh pr view "$PR_NUMBER" --json isDraft -q '.isDraft')
            if [ "$IS_DRAFT" = "true" ]; then
              echo "PR #$PR_NUMBER is a draft. Skipping auto-merge."
              exit 0
            fi
            if [ "$MERGEABLE" = "MERGEABLE" ] || [ "$MERGEABLE" = "CONFLICTING" ]; then
              break
            fi
            sleep 5
          done

          if [ "$MERGEABLE" = "CONFLICTING" ]; then
            echo "PR #$PR_NUMBER has conflicts."
            exit 1
          fi

          echo "Auto-merge is currently disabled."
