---
# Grafana - Dashboards and Visualization
apiVersion: v1
kind: ConfigMap
metadata:
  name: opentelemetry-demo-grafana-datasources
  labels:
    opentelemetry.io/name: opentelemetry-demo-grafana
    app.kubernetes.io/instance: opentelemetry-demo
    app.kubernetes.io/component: grafana
    app.kubernetes.io/name: opentelemetry-demo-grafana
    app.kubernetes.io/part-of: opentelemetry-demo
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        uid: webstore-metrics
        url: http://opentelemetry-demo-prometheus-server:9090
        isDefault: true
        editable: true
      - name: Jaeger
        type: jaeger
        uid: webstore-traces
        url: http://opentelemetry-demo-jaeger-query:16686
        editable: true
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: opentelemetry-demo-grafana-dashboard-provisioning
  labels:
    opentelemetry.io/name: opentelemetry-demo-grafana
    app.kubernetes.io/instance: opentelemetry-demo
    app.kubernetes.io/component: grafana
    app.kubernetes.io/name: opentelemetry-demo-grafana
    app.kubernetes.io/part-of: opentelemetry-demo
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
      - name: 'kubernetes'
        orgId: 1
        folder: 'Kubernetes'
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: opentelemetry-demo-grafana-dashboards
  labels:
    opentelemetry.io/name: opentelemetry-demo-grafana
    app.kubernetes.io/instance: opentelemetry-demo
      "schemaVersion": 40,
      "tags": [
        "opentelemetry",
        "monitoring"
      ],
      "templating": {
        "list": [
          {
            "current": {},
            "includeAll": false,
            "label": "Datasource",
            "name": "datasource",
            "options": [],
            "query": "prometheus",
            "refresh": 1,
            "regex": "",
            "type": "datasource"
          }
        ]
      },
      "time": {
        "from": "now-6h",
        "to": "now"
      },
      "timepicker": {},
      "timezone": "utc",
      "title": "OpenTelemetry Collector",
      "uid": "BKf2sowmj",
      "version": 1,
      "weekStart": ""
    }
  spanmetrics-dashboard.json: |
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {
              "type": "grafana",
              "uid": "-- Grafana --"
            },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "target": {
              "limit": 100,
              "matchAny": false,
              "tags": [],
              "type": "dashboard"
            },
            "type": "dashboard"
          }
        ]
      },
      "description": "Spanmetrics way of demo application view.",
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "id": 5,
      "links": [],
      "panels": [],
      "preload": false,
      "refresh": "5m",
      "schemaVersion": 40,
      "tags": [],
      "templating": {
        "list": [
          {
            "allValue": ".*",
            "current": {
              "text": "All",
              "value": "$__all"
            },
            "datasource": {
              "type": "prometheus",
              "uid": "webstore-metrics"
            },
            "definition": "query_result(count by (service_name)(count_over_time(traces_span_metrics_calls_total[$__range])))",
            "includeAll": true,
            "multi": true,
            "name": "service",
            "options": [],
            "query": {
              "query": "query_result(count by (service_name)(count_over_time(traces_span_metrics_calls_total[$__range])))",
              "refId": "StandardVariableQuery"
            },
            "refresh": 2,
            "regex": "/.*service_name=\"(.*)\".*/",
            "sort": 1,
            "type": "query"
          },
          {
            "allValue": ".*",
            "current": {
              "text": "All",
              "value": "$__all"
            },
            "datasource": {
              "type": "prometheus",
              "uid": "webstore-metrics"
            },
            "definition": "query_result(sum ({__name__=~\".*traces_span_metrics_calls_total\",service_name=~\"$service\"})  by (span_name))",
            "includeAll": true,
            "multi": true,
            "name": "span_name",
            "options": [],
            "query": {
              "query": "query_result(sum ({__name__=~\".*traces_span_metrics_calls_total\",service_name=~\"$service\"})  by (span_name))",
              "refId": "StandardVariableQuery"
            },
            "refresh": 2,
            "regex": "/.*span_name=\"(.*)\".*/",
            "type": "query"
          }
        ]
      },
      "time": {
        "from": "now-1h",
        "to": "now"
      },
      "timepicker": {},
      "timezone": "",
      "title": "Spanmetrics Demo Dashboard",
      "uid": "W2gX2zHVk48",
      "version": 1,
      "weekStart": ""
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: opentelemetry-demo-grafana
  labels:
    opentelemetry.io/name: opentelemetry-demo-grafana
    app.kubernetes.io/instance: opentelemetry-demo
    app.kubernetes.io/component: grafana
    app.kubernetes.io/name: opentelemetry-demo-grafana
    app.kubernetes.io/part-of: opentelemetry-demo
spec:
  replicas: 1
  selector:
    matchLabels:
      opentelemetry.io/name: opentelemetry-demo-grafana
  template:
    metadata:
      labels:
        opentelemetry.io/name: opentelemetry-demo-grafana
        app.kubernetes.io/instance: opentelemetry-demo
        app.kubernetes.io/component: grafana
        app.kubernetes.io/name: opentelemetry-demo-grafana
    spec:
      serviceAccountName: opentelemetry-demo
      initContainers:
        - name: demo-dashboards
          image: curlimages/curl:8.10.1
          command:
            - /bin/sh
            - -c
            - >
              set -e;
              mkdir -p /dashboards/demo;
              for f in demo-dashboard.json exemplars-dashboard.json opentelemetry-collector-data-flow.json opentelemetry-collector.json spanmetrics-dashboard.json; do
                curl -fsSL https://raw.githubusercontent.com/open-telemetry/opentelemetry-demo/main/src/grafana/provisioning/dashboards/demo/$f -o /dashboards/demo/$f;
              done
          volumeMounts:
            - name: demo-dashboards
              mountPath: /dashboards
      containers:
        - name: grafana
          image: grafana/grafana:10.3.1
          imagePullPolicy: IfNotPresent
          env:
            - name: GF_SECURITY_ADMIN_USER
              value: admin
            - name: GF_SECURITY_ADMIN_PASSWORD
              value: admin
            - name: GF_PATHS_PROVISIONING
              value: /etc/grafana/provisioning
            - name: GF_AUTH_ANONYMOUS_ENABLED
              value: "true"
            - name: GF_AUTH_ANONYMOUS_ORG_ROLE
              value: Admin
            - name: GF_SERVER_ROOT_URL
              value: "%(protocol)s://%(domain)s:%(http_port)s/grafana"
            - name: GF_SERVER_SERVE_FROM_SUB_PATH
              value: "true"
          ports:
            - containerPort: 3000
              name: http
              protocol: TCP
          volumeMounts:
            - name: datasources
              mountPath: /etc/grafana/provisioning/datasources
            - name: dashboard-provisioning
              mountPath: /etc/grafana/provisioning/dashboards
            - name: dashboards
              mountPath: /var/lib/grafana/dashboards
            - name: demo-dashboards
              mountPath: /var/lib/grafana/dashboards/demo
          resources:
            limits:
              memory: 150Mi
              cpu: 500m
            requests:
              memory: 100Mi
              cpu: 100m
          readinessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 10
      volumes:
        - name: datasources
          configMap:
            name: opentelemetry-demo-grafana-datasources
        - name: dashboard-provisioning
          configMap:
            name: opentelemetry-demo-grafana-dashboard-provisioning
        - name: dashboards
          configMap:
            name: opentelemetry-demo-grafana-dashboards
        - name: demo-dashboards
          emptyDir: {}
